<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –ú–æ–∑–≥–æ–≤ - Brainzzz</title>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9em;
        }
        
        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .visualization {
            display: flex;
            height: 600px;
        }
        
        .graph-container {
            flex: 2;
            border: 1px solid #e9ecef;
            position: relative;
        }
        
        .sidebar {
            flex: 1;
            background: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .brain-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .brain-info h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .info-value {
            color: #495057;
            font-weight: 600;
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .stat-value {
            color: #495057;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6c757d;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –ú–æ–∑–≥–æ–≤</h1>
            <p>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="brain-selector">–í—ã–±—Ä–∞—Ç—å –º–æ–∑–≥:</label>
                <select id="brain-selector">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="layout-selector">–†–∞—Å–∫–ª–∞–¥–∫–∞:</label>
                <select id="layout-selector">
                    <option value="cola">Cola (—Ñ–∏–∑–∏—á–µ—Å–∫–∞—è)</option>
                    <option value="cose">Cose (–±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è)</option>
                    <option value="grid">–°–µ—Ç–∫–∞</option>
                    <option value="circle">–ö—Ä—É–≥</option>
                    <option value="breadthfirst">–®–∏—Ä–∏–Ω–∞</option>
                    <option value="depthfirst">–ì–ª—É–±–∏–Ω–∞</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="node-size">–†–∞–∑–º–µ—Ä —É–∑–ª–æ–≤:</label>
                <input type="range" id="node-size" min="10" max="50" value="20">
            </div>
            
            <button class="btn" onclick="refreshBrain()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="btn" onclick="exportGraph()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
        </div>
        
        <div class="visualization">
            <div class="graph-container" id="cy">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏...</div>
            </div>
            
            <div class="sidebar">
                <div class="brain-info">
                    <h3>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–∑–≥–µ</h3>
                    <div class="info-row">
                        <span class="info-label">ID:</span>
                        <span class="info-value" id="brain-id">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–£–∑–ª—ã:</span>
                        <span class="info-value" id="brain-nodes">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–°–≤—è–∑–∏:</span>
                        <span class="info-value" id="brain-connections">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">GP:</span>
                        <span class="info-value" id="brain-gp">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">–ü—Ä–∏—Å–ø–æ—Å–æ–±–ª–µ–Ω–Ω–æ—Å—Ç—å:</span>
                        <span class="info-value" id="brain-fitness">-</span>
                    </div>
                </div>
                
                <div class="stats">
                    <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div class="stat-item">
                        <span class="stat-label">–°—Ä–µ–¥–Ω—è—è —Å—Ç–µ–ø–µ–Ω—å:</span>
                        <span class="stat-value" id="avg-degree">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–î–∏–∞–º–µ—Ç—Ä:</span>
                        <span class="stat-value" id="diameter">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ü–ª–æ—Ç–Ω–æ—Å—Ç—å:</span>
                        <span class="stat-value" id="density">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è:</span>
                        <span class="stat-value" id="clustering">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cy = null;
        let currentBrain = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Cytoscape
        function initCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: [],
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': '#667eea',
                            'label': 'data(label)',
                            'color': 'white',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'width': 'data(size)',
                            'height': 'data(size)',
                            'border-color': '#495057',
                            'border-width': '2px'
                        }
                    },
                    {
                        selector: 'node[type="input"]',
                        style: {
                            'background-color': '#28a745',
                            'shape': 'rectangle'
                        }
                    },
                    {
                        selector: 'node[type="output"]',
                        style: {
                            'background-color': '#dc3545',
                            'shape': 'rectangle'
                        }
                    },
                    {
                        selector: 'node[type="hidden"]',
                        style: {
                            'background-color': '#667eea',
                            'shape': 'ellipse'
                        }
                    },
                    {
                        selector: 'node[type="memory"]',
                        style: {
                            'background-color': '#ffc107',
                            'shape': 'diamond'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 'data(weight)',
                            'line-color': 'data(color)',
                            'target-arrow-color': 'data(color)',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'color': '#495057'
                        }
                    },
                    {
                        selector: 'edge[weight > 0.5]',
                        style: {
                            'line-color': '#28a745',
                            'target-arrow-color': '#28a745'
                        }
                    },
                    {
                        selector: 'edge[weight < -0.5]',
                        style: {
                            'line-color': '#dc3545',
                            'target-arrow-color': '#dc3545'
                        }
                    }
                ],
                layout: {
                    name: 'cola',
                    animate: true,
                    animationDuration: 1000,
                    fit: true,
                    padding: 50
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                showNodeInfo(node);
            });
            
            cy.on('tap', 'edge', function(evt) {
                const edge = evt.target;
                showEdgeInfo(edge);
            });
            
            cy.on('cxttap', function(evt) {
                if (evt.target === cy) {
                    cy.elements().removeClass('highlighted');
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            document.querySelector('.loading').style.display = 'none';
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–æ–∑–≥–æ–≤
        async function loadBrains() {
            try {
                const response = await fetch('/api/population');
                const brains = await response.json();
                
                const selector = document.getElementById('brain-selector');
                selector.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–∑–≥...</option>';
                
                brains.forEach(brain => {
                    const option = document.createElement('option');
                    option.value = brain.id;
                    option.textContent = `–ú–æ–∑–≥ ${brain.id} (${brain.nodes} —É–∑–ª–æ–≤, —Ñ–∏—Ç–Ω–µ—Å: ${brain.fitness.toFixed(3)})`;
                    selector.appendChild(option);
                });
                
                if (brains.length > 0) {
                    selector.value = brains[0].id;
                    loadBrainData(brains[0].id);
                }
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–æ–∑–≥–æ–≤: ' + error.message);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–∑–≥–∞
        async function loadBrainData(brainId) {
            try {
                const response = await fetch(`/api/population/${brainId}`);
                const brain = await response.json();
                
                currentBrain = brain;
                updateBrainInfo(brain);
                visualizeBrain(brain);
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–æ–∑–≥–∞: ' + error.message);
            }
        }
        
        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∑–≥–∞
        function visualizeBrain(brain) {
            if (!cy) return;
            
            // –û—á–∏—â–∞–µ–º –≥—Ä–∞—Ñ
            cy.elements().remove();
            
            // –°–æ–∑–¥–∞–µ–º —É–∑–ª—ã
            const nodes = [];
            const edges = [];
            
            // –î–æ–±–∞–≤–ª—è–µ–º —É–∑–ª—ã
            brain.nodes.forEach((node, index) => {
                nodes.push({
                    data: {
                        id: `n${index}`,
                        label: `${node.type}\n${node.activation}`,
                        size: parseInt(document.getElementById('node-size').value),
                        type: node.type
                    }
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏
            brain.connections.forEach((conn, index) => {
                edges.push({
                    data: {
                        id: `e${index}`,
                        source: `n${conn.from}`,
                        target: `n${conn.to}`,
                        weight: Math.abs(conn.weight),
                        color: conn.weight > 0 ? '#28a745' : '#dc3545',
                        label: conn.weight.toFixed(2)
                    }
                });
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –≥—Ä–∞—Ñ
            cy.add([...nodes, ...edges]);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å–∫–ª–∞–¥–∫—É
            applyLayout();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateGraphStats();
        }
        
        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∫–∏
        function applyLayout() {
            const layoutName = document.getElementById('layout-selector').value;
            
            const layout = cy.layout({
                name: layoutName,
                animate: true,
                animationDuration: 1000,
                fit: true,
                padding: 50
            });
            
            layout.run();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–∑–≥–µ
        function updateBrainInfo(brain) {
            document.getElementById('brain-id').textContent = brain.id;
            document.getElementById('brain-nodes').textContent = brain.nodes.length;
            document.getElementById('brain-connections').textContent = brain.connections.length;
            document.getElementById('brain-gp').textContent = brain.gp.toFixed(2);
            document.getElementById('brain-fitness').textContent = brain.fitness.toFixed(3);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≥—Ä–∞—Ñ–∞
        function updateGraphStats() {
            if (!cy || cy.elements().length === 0) return;
            
            const nodes = cy.nodes();
            const edges = cy.edges();
            
            // –°—Ä–µ–¥–Ω—è—è —Å—Ç–µ–ø–µ–Ω—å
            const avgDegree = edges.length / nodes.length;
            document.getElementById('avg-degree').textContent = avgDegree.toFixed(2);
            
            // –î–∏–∞–º–µ—Ç—Ä (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
            const diameter = cy.elements().dijkstra().max;
            document.getElementById('diameter').textContent = diameter ? diameter.distance.toFixed(2) : 'N/A';
            
            // –ü–ª–æ—Ç–Ω–æ—Å—Ç—å
            const maxEdges = nodes.length * (nodes.length - 1);
            const density = maxEdges > 0 ? edges.length / maxEdges : 0;
            document.getElementById('density').textContent = density.toFixed(3);
            
            // –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
            const clustering = cy.elements().clusteringCoefficient();
            document.getElementById('clustering').textContent = clustering.toFixed(3);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É–∑–ª–µ
        function showNodeInfo(node) {
            cy.elements().removeClass('highlighted');
            node.addClass('highlighted');
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            node.connectedEdges().addClass('highlighted');
            node.connectedNodes().addClass('highlighted');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤—è–∑–∏
        function showEdgeInfo(edge) {
            cy.elements().removeClass('highlighted');
            edge.addClass('highlighted');
            edge.source().addClass('highlighted');
            edge.target().addClass('highlighted');
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –º–æ–∑–≥
        function refreshBrain() {
            const brainId = document.getElementById('brain-selector').value;
            if (brainId) {
                loadBrainData(brainId);
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∞
        function exportGraph() {
            if (!cy) return;
            
            const png = cy.png({
                scale: 2,
                quality: 1,
                output: 'blob'
            });
            
            const url = URL.createObjectURL(png);
            const a = document.createElement('a');
            a.href = url;
            a.download = `brain_${currentBrain?.id || 'unknown'}.png`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('brain-selector').addEventListener('change', function() {
            if (this.value) {
                loadBrainData(this.value);
            }
        });
        
        document.getElementById('layout-selector').addEventListener('change', function() {
            applyLayout();
        });
        
        document.getElementById('node-size').addEventListener('input', function() {
            if (currentBrain) {
                visualizeBrain(currentBrain);
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', function() {
            initCytoscape();
            loadBrains();
        });
    </script>
</body>
</html> 